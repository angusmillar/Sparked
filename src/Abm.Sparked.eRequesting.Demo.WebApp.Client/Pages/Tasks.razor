@page "/tasks"
@using System.Globalization
@using System.Security.AccessControl
@using Abm.Sparked.eRequesting.Demo.Common.Services
@using Abm.Sparked.eRequesting.Demo.Common.ViewModels
@using Abm.Sparked.eRequesting.Demo.WebApp.Client.Components

@inject IRequestingService RequestingService
@inject IDialogService DialogService

<script>
    window.highlight = (code) => {
        return Prism.highlight(code, Prism.languages.json, 'json');
    }
</script>

<PageTitle>Tasks</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Tasks</MudText>
<MudText Class="mb-8">Where ???</MudText>

@if (_taskVmList == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true"/>
}
else
{
    <MudSwitch @bind-Value="IsPolling" Label="@(IsPolling ? "Polling Enabled" : "Polling Disabled")" @onclick="TogglePolling" Color="Color.Success"/>
    
    <MudDataGrid Items="@_taskVmList"
                 ReadOnly="@IsReadOnly" EditMode="@DataGridEditMode.Cell">
        <Columns>
            <HierarchyColumn T="TaskVm"/>
            <TemplateColumn  Title="Category">
                <CellTemplate>
                    <MudStack Row>
                        <MudAvatar Color="Color.Secondary" Variant="Variant.Outlined">
                            <MudIcon Icon="@Icons.Material.Rounded.Biotech" />
                        </MudAvatar>
                        <MudStack>
                            <MudText Typo="Typo.body1">@EmptyIfNull(context.Item.Id)</MudText>
                            <MudText Typo="Typo.body2">@EmptyIfNull(context.Item.Intent)</MudText>
                        </MudStack>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => EmptyIfNull(x.Id)" Title="Resource Id"/>
            <PropertyColumn Property="x => x.AuthoredOn.ToString(CultureInfo.CurrentCulture)" Title="AuthoredOn"/>
            <PropertyColumn Property="x => x.LastUpdated.ToString(CultureInfo.CurrentCulture)" Title="LastUpdated"/>
        </Columns>
        <ChildRowContent>
            <MudCard>
                <MudCardHeader>
                   
                    <CardHeaderContent>
                        <MudText Typo="Typo.body1">@EmptyIfNull(context.Item.Id)</MudText>
                        <MudText Typo="Typo.body2">@EmptyIfNull(context.Item.Intent)</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudIconButton Icon="@Icons.Material.Filled.Code" Color="Color.Default" @onclick="() => ShowFhirResourceJson(context.Item.Id)" />
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <MudPaper>
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="4">
                            <MudField Label="Resource Id" Variant="Variant.Outlined">@context.Item.Id</MudField>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudField Label="Intent" Variant="Variant.Outlined">@context.Item.Intent</MudField>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudTextField T="DateTime" Format="s" @bind-Value="context.Item.AuthoredOn" Label="Authored On" ReadOnly="true" Variant="Variant.Outlined"/>
                        </MudItem>
                    </MudGrid>
                    </MudPaper>
                </MudCardContent>
            </MudCard>
        </ChildRowContent>
        <PagerContent>
            <MudDataGridPager T="TaskVm"/>
        </PagerContent>
    </MudDataGrid>
    
}

@code {
    private TaskVm[]? _taskVmList;
    private PeriodicTimer? _pollingTimer = null;
    private bool IsPolling { get; set; } = false;
    private bool IsReadOnly { get; set; } = true;


    protected override async Task OnInitializedAsync()
    {
        await RefreshList();
    }

    private async Task RefreshList()
    {
        _taskVmList = (await RequestingService.GetTaskVmList()).ToArray();
    }

    private string EmptyIfNull(string? item)
    {
        if (string.IsNullOrWhiteSpace(item))
        {
            return string.Empty;
        }

        return item;
    }

    private async Task TogglePolling()
    {
        if (_pollingTimer is not null)
        {
            _pollingTimer.Dispose();
            _pollingTimer = null;
            IsPolling = false;
            return;
        }

        IsPolling = true;
        await RefreshList();

        _pollingTimer = new PeriodicTimer(new TimeSpan(0, 0, 5));
        while (await _pollingTimer.WaitForNextTickAsync())
        {
            await RefreshList();
            await InvokeAsync(StateHasChanged);
        }
    }

    async Task ShowFhirResourceJson(string resourceId)
    {
        string? jsonValue = await RequestingService.GetServiceRequestJson(resourceId);
        //const string JsonValue = "{\"menu\": {\n  \"id\": \"file\",\n  \"value\": \"File\",\n  \"{resourceId}\": {\n    \"menuitem\": [\n      {\"value\": \"New\", \"onclick\": \"CreateNewDoc()\"},\n      {\"value\": \"Open\", \"onclick\": \"OpenDoc()\"},\n      {\"value\": \"Close\", \"onclick\": \"CloseDoc()\"}\n    ]\n  }\n}}";

        var parameters = new DialogParameters<JsonDialog>();
        parameters.Add(x => x.ContentText, jsonValue ?? $"[[base]/ServiceRequest/{resourceId} was not found!]");
        parameters.Add(x => x.ResourceType, "ServiceRequest" );
        parameters.Add(x => x.ResourceId, resourceId);

        var options = new DialogOptions()
        {
            Position = DialogPosition.TopCenter,
            MaxWidth = MaxWidth.ExtraExtraLarge,
            FullWidth = true,
            CloseButton = true,
            FullScreen = false,
            CloseOnEscapeKey = true
        };

        IDialogReference dialog = await DialogService.ShowAsync<JsonDialog>($"[base]ServiceRequest/{resourceId}", parameters, options);
        var result = await dialog.Result;
    }


}